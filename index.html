<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>주간업무 보고 — 읽기 전용(자동 탐색 · 고장난 경우 진단)</title>
  <style>
    :root{--bg:#0b1020;--card:#12183a;--line:#26326b;--ink:#e8ebff;--muted:#9fb0ff}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:24px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);margin-bottom:16px}
    .hd{padding:18px 20px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .bd{padding:20px}
    .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    select,input,button{background:#0e1330;border:1px solid #2a3772;color:#cfe2ff;border-radius:10px;padding:10px 12px}
    button{cursor:pointer;font-weight:600}
    .muted{color:var(--muted)}
    .ok{color:#7af57a;font-weight:700}
    .warn{color:#ffd56a;font-weight:700}
    .err{color:#ff8383;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{border:1px dashed var(--line);border-radius:12px;padding:12px}
    h1{font-size:20px;margin:0}
    h2{font-size:16px;margin:0 0 8px 0}
    ul{margin:6px 0 0 18px}
    .small{font-size:12px}
    code,pre{background:#0e1330;border:1px solid #2a3772;color:#cfe2ff;border-radius:10px;padding:12px;display:block;overflow:auto}
    .badge{border:1px solid var(--line);border-radius:999px;padding:2px 8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">
        <h1>주간업무 보고 — 읽기 전용</h1>
        <div class="muted small">컬렉션그룹/루트 자동 탐색 • 인덱스 문제 감지 • 클라이언트 정렬</div>
      </div>
      <div class="bd">
        <div class="flex">
          <div>상태: <span id="status" class="warn">초기화 대기…</span></div>
          <div id="found" class="badge muted small">0건</div>
        </div>
        <div class="flex" style="margin-top:12px">
          <label class="small">보고서 선택</label>
          <select id="reportSelect" style="min-width:420px">
            <option value="">(로딩 중…)</option>
          </select>
          <button id="reloadBtn">다시 불러오기</button>
        </div>
        <div id="hint" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>요약</h2><div id="weekRange" class="muted small"></div></div>
      <div class="bd grid">
        <div class="section">
          <h3>성과</h3>
          <ul id="achievements"></ul>
        </div>
        <div class="section">
          <h3>이슈</h3>
          <ul id="issues"></ul>
        </div>
        <div class="section">
          <h3>다음주 목표</h3>
          <ul id="goals"></ul>
        </div>
        <div class="section">
          <h3>프로젝트</h3>
          <ul id="projects"></ul>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>팀별</h2></div>
      <div class="bd grid">
        <div class="section">
          <h3>개발</h3>
          <ul id="team-dev"></ul>
        </div>
        <div class="section">
          <h3>퍼블리싱</h3>
          <ul id="team-pub"></ul>
        </div>
        <div class="section">
          <h3>QA</h3>
          <ul id="team-qa"></ul>
        </div>
        <div class="section">
          <h3>원본 데이터</h3>
          <pre id="raw"></pre>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>디버그</h2></div>
      <div class="bd">
        <div class="grid">
          <div class="section">
            <h3>현재 앱 옵션</h3>
            <pre id="appOptions">(없음)</pre>
          </div>
          <div class="section">
            <h3>로그</h3>
            <div id="log" class="small"></div>
          </div>
          <div class="section">
            <h3>경로 힌트</h3>
            <pre id="pathHints">(없음)</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collectionGroup, collection, getDocs, query, orderBy, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const $ = (s)=>document.querySelector(s);
    const $ul = (id)=>document.getElementById(id);
    const log = (m, cls="")=>{ const p=document.createElement("div"); if(cls) p.className=cls; p.textContent=m; $("#log").appendChild(p); };
    const setFound = n => $("#found").textContent = n + "건";

    // 1) firebaseConfig 값 채우기
    const firebaseConfig = {
      apiKey: "AIzaSyAAZ-D-Mxmt1uQ7W6223HTFr5IflAZAU2k",         // 콘솔에서 복사
      authDomain: "donald-b4df1.firebaseapp.com",     // 콘솔에서 복사
      projectId: "donald-b4df1",      // 콘솔에서 복사
      appId: "1:231861185650:web:2079dd7290445ca4f2a6eb"           // 콘솔에서 복사
    };

    function computeWeekRange(dateStr){
      if(!dateStr) return "";
      const d = new Date(dateStr);
      const day = (d.getDay()+6)%7;
      const start = new Date(d); start.setDate(d.getDate()-day);
      const end = new Date(start); end.setDate(start.getDate()+6);
      const fmt = s => s.toISOString().slice(0,10);
      return `${fmt(start)} ~ ${fmt(end)}`;
    }
    function clearList(el){ while(el.firstChild) el.removeChild(el.firstChild); }
    function renderListSafe(el, arr){
      clearList(el);
      (arr||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent = String(t); el.appendChild(li); });
    }
    function renderProjects(el, arr){
      clearList(el);
      (arr||[]).forEach(p=>{
        const li = document.createElement("li");
        const name = (p && p.name) ? String(p.name) : "무제";
        const progress = (p && typeof p.progress==="number") ? Math.max(0, Math.min(100, Math.round(p.progress))) : 0;
        li.textContent = `${name} — ${progress}%`;
        el.appendChild(li);
      });
    }
    function normalizeDate(v){
      // Firestore Timestamp -> ISO, or keep string
      if(!v) return null;
      if(typeof v.toDate === "function"){ return v.toDate().toISOString().slice(0,10); }
      if(typeof v === "string"){ return v; }
      return null;
    }

    async function main(){
      try{
        const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
        $("#status").textContent = "앱 초기화 완료. 연결 시도 중…";
        $("#status").className = "warn";
        $("#appOptions").textContent = JSON.stringify(app.options, null, 2);

        try{
          await signInAnonymously(getAuth(app));
          log("익명 로그인 성공", "ok");
        }catch(e){
          log("익명 로그인 실패: " + (e.code||e.message), "warn");
        }

        const db = getFirestore(app);
        await loadRecentList(db);
        $("#reloadBtn").addEventListener("click", ()=>loadRecentList(db));
        $("#reportSelect").addEventListener("change", ()=>loadSelected(db));
      }catch(e){
        $("#status").textContent = "Firebase 초기화 오류";
        $("#status").className = "err";
        log("[init] " + (e.code||e.message), "err");
      }
    }

    async function loadRecentList(db){
      $("#status").textContent = "목록 불러오는 중…";
      $("#status").className = "warn";
      $("#hint").textContent = "";
      $("#pathHints").textContent = "(없음)";

      let docs = [];
      let hints = [];

      // Method A: collectionGroup + orderBy(date desc)
      try{
        const q1 = query(collectionGroup(db, "weekly_reports"), orderBy("date","desc"), limit(200));
        const s1 = await getDocs(q1);
        docs = s1.docs.slice();
        hints.push(`[A] collectionGroup weekly_reports + orderBy(date) → ${s1.size}건`);
      }catch(e){
        log("[A] " + (e.code||e.message), "warn");
        if((e.code||"").includes("failed-precondition")){
          $("#hint").innerHTML = "인덱스 필요: 콘솔 로그의 링크를 눌러 인덱스를 생성하세요.";
        }
      }

      // Fallback B: collectionGroup without orderBy (no index required), then client-side sort
      if(docs.length === 0){
        try{
          const s2 = await getDocs(collectionGroup(db, "weekly_reports"));
          docs = s2.docs.slice();
          hints.push(`[B] collectionGroup weekly_reports (무정렬) → ${s2.size}건`);
        }catch(e){
          log("[B] " + (e.code||e.message), "warn");
        }
      }

      // Fallback C: 루트 컬렉션 'weekly_reports' (옛 경로 호환)
      if(docs.length === 0){
        try{
          const s3 = await getDocs(collection(db, "weekly_reports"));
          docs = s3.docs.slice();
          hints.push(`[C] root weekly_reports → ${s3.size}건`);
        }catch(e){
          log("[C] " + (e.code||e.message), "warn");
        }
      }

      // nothing found
      if(docs.length === 0){
        setFound(0);
        $("#status").textContent = "연결 성공(데이터 0건) — 컬렉션/경로/규칙을 확인하세요";
        $("#status").className = "err";
        $("#pathHints").textContent = hints.join("\n");
        return;
      }

      // Client-side sort by date desc (normalized)
      docs.sort((a,b)=>{
        const da = normalizeDate(a.data().date) || "";
        const dbv = normalizeDate(b.data().date) || "";
        return dbv.localeCompare(da);
      });

      const sel = $("#reportSelect");
      sel.innerHTML = "";
      docs.forEach(d=>{
        const data = d.data();
        const date = normalizeDate(data.date) || "(날짜없음)";
        const title = (data.summary && data.summary.title) || (data.projects && data.projects[0] && data.projects[0].name) || "무제";
        const opt = document.createElement("option");
        opt.value = d.ref.path; // 전체 문서 경로
        opt.textContent = `${date} · ${title}  —  ${d.ref.path}`;
        sel.appendChild(opt);
      });

      setFound(docs.length);
      $("#status").textContent = "연결 성공 (읽기 전용)";
      $("#status").className = "ok";
      $("#pathHints").textContent = hints.join("\n");

      if(sel.options.length){ await loadSelected(db); }
    }

    async function loadSelected(db){
      const sel = $("#reportSelect");
      const path = sel.value;
      if(!path) return;
      try{
        const d = await getDoc(doc(db, path));
        if(!d.exists()){ log("문서 없음", "warn"); return; }
        const data = d.data();

        const iso = normalizeDate(data.date);
        $("#weekRange").textContent = iso ? `보고 기간: ${computeWeekRange(iso)}` : "";

        renderListSafe($ul("achievements"), data.summary?.achievements);
        renderListSafe($ul("issues"), data.summary?.issues);
        renderListSafe($ul("goals"), data.summary?.goals);
        renderProjects($ul("projects"), data.projects);

        const dev = [].concat(data.teams?.dev?.completed||[], (data.teams?.dev?.planned||[]).map(x=>"[다음] "+x));
        const pub = [].concat(data.teams?.pub?.completed||[], (data.teams?.pub?.planned||[]).map(x=>"[다음] "+x));
        const qa  = [].concat(data.teams?.qa?.completed||[],  (data.teams?.qa?.planned||[]).map(x=>"[다음] "+x));
        renderListSafe($ul("team-dev"), dev);
        renderListSafe($ul("team-pub"), pub);
        renderListSafe($ul("team-qa"), qa);

        $("#raw").textContent = JSON.stringify(data, null, 2);
      }catch(e){
        log("[load] " + (e.code||e.message), "err");
      }
    }

    main();
  </script>
</body>
</html>
